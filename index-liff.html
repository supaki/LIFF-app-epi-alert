<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผูกบัญชี LINE กับระบบนัดวัคซีน v3</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
        <h1 class="text-2xl font-bold mb-4">ผูกบัญชี LINE กับระบบนัดวัคซีน</h1>
        <div id="status" class="mb-4 text-gray-700">กำลังตรวจสอบข้อมูล...</div>
        <button id="addFriendBtn" class="hidden bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mb-4">
            <i class="fab fa-line mr-2"></i>เพิ่มเพื่อนกับ LINE Bot
        </button>
        <div id="result" class="text-lg font-semibold"></div>
    </div>
    
    <!-- Debug Information -->
    <div id="debug-info" class="fixed bottom-0 left-0 right-0 bg-black bg-opacity-80 text-white text-xs p-2 max-h-40 overflow-y-auto"></div>

    <script>
        // Debug function
        function debugLog(message, data) {
            console.log('LIFF DEBUG:', message, data);
            const debugDiv = document.getElementById('debug-info');
            if (debugDiv) {
                debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message} ${data ? JSON.stringify(data) : ''}</div>`;
            }
        }

        // Global variables for configuration
        const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwPwiSMPSdXZ9RqoCW6X9-YMbITYDJY1DLxSj4_NCS60_0j5mh6ibELr6qWPtAe-v0N/exec';
        const BOT_BASIC_ID = '@829aobqk';

        document.addEventListener('DOMContentLoaded', async function() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            const addFriendBtn = document.getElementById('addFriendBtn');

            debugLog('LIFF App started');
            debugLog('URL', window.location.href);
            debugLog('Search params', window.location.search);

            // ดึง cid จาก query string หรือจาก localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let cid = urlParams.get('cid');
            debugLog('cid from query', cid);

            if (!cid) {
                // กรณีถูก redirect หลัง LINE Login จะมี state parameter
                const state = urlParams.get('state');
                debugLog('state param', state);
                if (state && state.startsWith('cid-')) {
                    cid = state.replace('cid-', '');
                    debugLog('cid from state', cid);
                }
            }

            if (!cid) {
                // ตรวจสอบ liff.state parameter ที่อาจจะมี encoded URL
                const liffState = urlParams.get('liff.state');
                debugLog('liff.state param', liffState);
                if (liffState) {
                    try {
                        const decodedState = decodeURIComponent(liffState);
                        debugLog('decoded liff.state', decodedState);
                        
                        // ตรวจสอบทั้ง query string (?) และ fragment (#)
                        if (decodedState.startsWith('?')) {
                            const stateParams = new URLSearchParams(decodedState);
                            cid = stateParams.get('cid');
                            debugLog('cid from liff.state query', cid);
                        } else if (decodedState.startsWith('#')) {
                            // ประมวลผล fragment
                            const fragmentParams = new URLSearchParams(decodedState.substring(1));
                            cid = fragmentParams.get('cid');
                            debugLog('cid from liff.state fragment', cid);
                        }
                    } catch (e) {
                        debugLog('Error decoding liff.state', e.message);
                    }
                }
            }

            if (!cid) {
                cid = urlParams.get('pid');
                debugLog('cid from pid', cid);
            }

            if (!cid) {
                // ตรวจสอบจาก URL fragment (สำหรับ redirect flow)
                const fragment = window.location.hash;
                debugLog('URL fragment', fragment);
                if (fragment && fragment.startsWith('#')) {
                    const fragmentParams = new URLSearchParams(fragment.substring(1));
                    const fragmentCid = fragmentParams.get('cid');
                    debugLog('cid from fragment', fragmentCid);
                    if (fragmentCid) {
                        cid = fragmentCid;
                        debugLog('Using CID from URL fragment');
                    }
                }
            }

            if (!cid) {
                // ตรวจสอบจาก localStorage เป็นตัวเลือกสำรอง
                const storedCid = localStorage.getItem('pendingCid');
                debugLog('cid from localStorage', storedCid);
                if (storedCid) {
                    cid = storedCid;
                    localStorage.removeItem('pendingCid');
                    debugLog('Using stored CID and removed from localStorage');
                }
            }

            if (!cid) {
                statusDiv.textContent = 'ไม่พบเลขบัตรประชาชน (cid/pid)';
                debugLog('No CID found');
                return;
            }

            // เพิ่มฟังก์ชันตรวจสอบ cid
            function validateCid(cid) {
                return typeof cid === 'string' && /^\d{13}$/.test(cid);
            }

            if (!cid || !validateCid(cid)) {
                statusDiv.textContent = 'เลขบัตรประชาชน (cid) ไม่ถูกต้อง ต้องเป็นตัวเลข 13 หลัก';
                debugLog('Invalid CID', cid);
                return;
            }

            debugLog('Valid CID found', cid);

            // เริ่มต้น LIFF
            try {
                await liff.init({ liffId: '2007905473-Vqw5RZBv' });
                debugLog('LIFF initialized');

                if (!liff.isLoggedIn()) {
                    debugLog('Not logged in, starting login');
                    liff.login();
                    return;
                }

                statusDiv.textContent = 'กำลังดึงข้อมูลบัญชี LINE...';
                const profile = await liff.getProfile();
                const userId = profile.userId;
                debugLog('LINE profile', { userId: userId, displayName: profile.displayName });

                // แสดงปุ่มเพิ่มเพื่อน
                addFriendBtn.classList.remove('hidden');
                addFriendBtn.onclick = function() {
                    window.open('https://line.me/R/ti/p/~' + BOT_BASIC_ID, '_blank');
                };

                // ส่ง userId + cid ไปบันทึกใน backend
                statusDiv.textContent = 'กำลังผูกบัญชี...';
                debugLog('Saving LINE ID to person', { cid, userId });

                fetch(GAS_WEBAPP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveLineIdToPerson', cid: cid, lineUserId: userId }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    debugLog('Backend response', data);
                    if (data.success) {
                        statusDiv.textContent = '';
                        resultDiv.textContent = 'ผูกบัญชี LINE กับระบบสำเร็จ!';
                        resultDiv.className = 'text-lg font-semibold text-green-600';
                    } else {
                        statusDiv.textContent = '';
                        resultDiv.textContent = 'เกิดข้อผิดพลาด: ' + (data.error || 'ไม่สามารถผูกบัญชีได้');
                        resultDiv.className = 'text-lg font-semibold text-red-600';
                    }
                })
                .catch(err => {
                    debugLog('Fetch error', err.message);
                    statusDiv.textContent = '';
                    resultDiv.textContent = 'เกิดข้อผิดพลาด: ' + err.message;
                    resultDiv.className = 'text-lg font-semibold text-red-600';
                });

            } catch (e) {
                debugLog('LIFF init error', e.message);
                statusDiv.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ LIFF: ' + e.message;
            }
        });
    </script>
</body>
</html>